$('body').on('click', '.btnDersiTakipEt', function () {

    var DersID = $(this).attr('data-DersID');

    var dugme = $(this);

    $.ajax({
        type: 'POST',
        url: '/Ajax/DersTakip/DersiTakipEt',
        data: "DersID=" + DersID,
        success: function (msg) {
            if (msg == 'derstakipediliyor') {
                location.href = "/Ders/?DersID=" + DersID;
            }
            else if (msg == 'takipistegigonderildi') {
                
                MesajKutusu(mesajlar.islemtamam, mesajlar.takipistegigonderildi);
            }
        },
        error: function (msg) {
            if (msg.status == 501) {
                console.log(msg.status);
                HataMesaji(mesajlar.derstakipediliyorveyaistekgonderilmis);
            }
            else {
                HataMesaji(mesajlar.islemsirasindahata);
            }
        }
    });


});

$('body').on('click', '.btnDersTakipOnayVer', function () {

    var DersID = $(this).attr('data-DersID');
    var UserID = $(this).attr('data-UserID');
    var satir = $(this).closest('tr');
    
    $.ajax({
        type: 'POST',
        url: '/Ajax/DersTakip/Onayla',
        data: "DersID=" + DersID + "&UserID=" + UserID,
        success: function (msg) {
            $(satir).animate({ backgroundColor: 'gray' }, 150).fadeOut(150, function () {
                $(satir).remove();                
            });
            
            MesajKutusu(mesajlar.islemtamam,mesajlar.ogrencibasariylaonaylandi);
        },
        error: function (msg) {
             
            HataMesaji(mesajlar.islemsirasindahata);
        }
    });
   

});


$('body').on('click', '.btnDersTakipEngelle', function () {

    var DersID = $(this).attr('data-DersID');
    var UserID = $(this).attr('data-UserID');
    var satir = $(this).closest('tr');
    
    if (confirm(mesajlar.ogrencierisimdurdurulacak)) {

        $.ajax({
            type: 'POST',
            url: '/Ajax/DersTakip/Engelle',
            data: "DersID=" + DersID + "&UserID=" + UserID,
            success: function (msg) {
                satir.remove();

                MesajKutusu(mesajlar.islemtamam, mesajlar.ogrenciderseerisimdurduruldu);
            },
            error: function (msg) {

                HataMesaji(mesajlar.islemsirasindahata);
            }
        });

    }


});



$('body').on('click', '.btnDersTakibiBirak', function () {

    var DersID = $(this).attr('data-DersID');
    if (confirm('Emin misiniz ?')) {
        
        $.ajax({
            type: 'POST',
            url: '/Ajax/DersTakip/TakibiBirak',
            data: "DersID=" + DersID,
            success: function (msg) {
                location.href = "/Panel";
            },
            error: function (msg) {
                
               HataMesaji(mesajlar.islemsirasindahata);
            }
        });
        
    }

});



$('body').on('click', '.btnDersTakipReddet', function () {

    var DersID = $(this).attr('data-DersID');
    var UserID = $(this).attr('data-UserID');
    var satir = $(this).closest('tr');
    
    $.ajax({
        type: 'POST',
        url: '/Ajax/DersTakip/Reddet',
        data: "DersID=" + DersID + "&UserID=" + UserID,
        success: function (msg) {
            $(satir).animate({ backgroundColor: 'gray' }, 150).fadeOut(150, function () {
                $(satir).remove();
                 
            });

        },
        error: function (msg) {
             
            HataMesaji(mesajlar.islemsirasindahata);
        }
    });
   

});

var $ogrenciler = $('#txtOgrenciler').selectize({

    valueField: 'userID',
    labelField: 'adsoyad',
    searchField: 'adsoyad',
    options: [],
    create: false,
    render: {
        option: function (item, escape) {

            return '<div class="media">' +
                            '<a class="pull-left" href="#">' +
                            '<img class="media-object img-circle" src="http://bulutders.blob.core.windows.net/profilresimleri/' + escape(item.Avatar) + '" width="48" height="48">' +
                            '</a>' +

                            '<div class="media-body">' +
                                '<h5 class="media-heading">' + escape(item.adsoyad) + '</h5>' +

                            '</div>' +
                            '</div>';

        }
    },

    load: function (query, callback) {
        if (!query.length) return callback();
        
        $.ajax({
            url: '/Ajax/JsonOgrenciListesi.cshtml',
            data: {
                sorgu: query
            },
            dataType: 'json',
            type: 'GET',
            error: function () {
                
                alert('hata');
                callback();
            },
            success: function (res) {
                
                callback(res);
            }
        });
        
    },

    onItemAdd:
            function (data, $item) {

                var DersID = $("#divDersRow").attr("data-DersID");
                var control = $ogrenciler[0].selectize;
                var UserID = control.getValue();
                var ogrenciAdiSoyadi = control.getItem(control.getValue()).text();
                
                $.ajax({
                    type: 'POST',
                    dataType: "json",
                    url: '/Ajax/DersTakip/ErisimIzniVer',
                    data: "DersID=" + DersID + "&UserID=" + UserID,
                    success: function (msg) {
                        /*
                         tabloDersTakip.row.add([
                             '<span><img src="http://bulutders.blob.core.windows.net/profilresimleri/' + msg.Avatar +'" class="img-circle" style="width:48px;height: 48px"> <a href="#"> ' + msg.Ad + ' ' + msg.Soyad + '</a></span>',
                            'Az Önce',
                            '<button class="btn btn-danger btnDersTakipEngelle btn-sm" data-DersID="'+ DersID +'" data-UserID="' + UserID +'"><i class="fa fa-remove"></i></button>'
                        ]).draw();*/
                        control.clear();
                         
                    },
                    error: function (msg) {
                         
                        HataMesaji(mesajlar.islemsirasindahata);
                    }
                });
               


            }

});


    $('#btnPanoMesajiGonder').click(function () {
        var DersID = $("#divDersRow").attr("data-DersID");
        var mesajMetni = $("#txtPanoMesaji").val();
        if (mesajMetni == '') {
            $("#txtPanoMesaji").focus();
            return false;
        }
       
        $.ajax({
            type: 'POST',
            url: '/Ajax/Ders/PanoyaMesajEkle',
            data: "DersID=" + DersID + "&MesajMetni=" + encodeURIComponent(mesajMetni),
            success: function (msg) {
                var eklenecekHtml = '<tr>' +
                '<td>' + $("#divAktifKullaniciKucukKunye").html() + '</td>' +
                '<td>' + mesajMetni + '</td>' +
                '<td class="text-right"> ' + mesajlar.azonce + ' </td>' +
                '<td class="text-right">' + '<button class="btn btn-danger btn-xs panoOgesiSil" data-PanoOgeID="' + msg + '"><i class="fa fa-remove"></i></button>' + '</td>'

                + '</tr>';
                $('#tableDersPanosu').prepend(eklenecekHtml);
                $("#txtPanoMesaji").val('');
                 
            },
            error: function (msg) {
                 
                HataMesaji(mesajlar.mesajpaylasilirkenhata);
            }
        });
       
    });



    $('body').on('click', '.panoOgesiSil', function () {

        var ID = $(this).attr('data-PanoOgeID');
        var satir = $(this).closest('tr');
        if (confirm(mesajlar.mesajsilinecek)) {
            $.ajax({
                type: 'POST',
                url: '/Ajax/Ders/PanodanMesajSil',
                data: "ID=" + ID,
                success: function (msg) {
                    $(satir).animate({ backgroundColor: 'gray' }, 150).fadeOut(150, function () {
                        $(satir).remove();
                    });

                },
                error: function (msg) {
                    HataMesaji(mesajlar.islemsirasindahata);
                }
            });
        }

    });


    $('#btnOdevVer').click(function () {

        var odevBaslik = $('#txtOdevBaslik').val();
        
        if (odevBaslik == '') {
            $('#txtOdevBaslik').focus();
            HataMesaji(mesajlar.basliksecilmedi);
            return false;
        }

        $.ajax({
            type: 'POST',
            url: '/Ajax/Odev/OdevVer',
            data: $('#frmOdevEkle').serialize(),
            success: function (msg) {
                var eklenecekHtml = '';
                eklenecekHtml = '<tr>';
                eklenecekHtml += '<td><a href="/Odev/Goster?OdevID=' + msg.OdevID + '"><i class="fa fa-clock-o fa-2x text-success"></i> ' + msg.Baslik + ' </a></td>';
                eklenecekHtml += '<td><div class="dropdown"><button id="dLabel" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="btn btn-primary btn-xs"><i class="fa fa-cog"></i><span class="caret"></span></button>';
                eklenecekHtml += '<ul class="dropdown-menu" aria-labelledby="dLabel">';
                eklenecekHtml += '<li><a href="/Odev/Goster?OdevID=' + msg.OdevID + '"><i class="fa fa-search-plus"></i> ' + mesajlar.gozat + '</a></li>';
                eklenecekHtml += '<li><a href="/Odev/Ayarlar?OdevID=' + msg.OdevID + '"><i class="fa fa-cog"></i> ' + mesajlar.odevayarlari + '</a></li>';
                eklenecekHtml += '<li><a href="/Odev/OdevGonderileri?OdevID=' + msg.OdevID + '"><i class="fa fa-user"></i> ' + mesajlar.odevinigonderenler + '</a></li>';
                eklenecekHtml += '<li><a href="#" class="btnOdevSil" data-OdevID="' + msg.OdevID + '"><i class="fa fa-remove"></i> Ödevi Sil</a></li></ul></div></td>';
                eklenecekHtml += '<td><a href="/Ders?DersID=' + msg.DersID + '"> ' + msg.DersAdi + ' </a> </td><td></td>';

                $('#lstOdevler tbody').prepend(eklenecekHtml);

                $('#modalDerseOdevVer').modal('hide');
                MesajKutusu(mesajlar.islemtamam, mesajlar.odevbasariylaeklendi);
            },

            error: function (msg) {
                if (msg.status == 502) {
                    HataMesaji(mesajlar.yetersizdepolamaalani);
                }
                else {
                    HataMesaji(mesajlar.verilmesirasindabirhataolustu);
                }
            }
        });

    });

    $('body').on('click', '.btnOdevSil', function () {
        var OdevID = $(this).attr('data-OdevID');
        var satir = $(this).closest('tr');
        if (confirm(mesajlar.odevsilinecek)) {

            $.ajax({
                type: 'POST',
                url: '/Ajax/Odev/OdevSil',
                data: "OdevID=" + OdevID,
                success: function (msg) {
                    satir.remove();
                },
                error: function (msg) {
                    HataMesaji(mesajlar.islemsirasindahata);
                }
            });
        }
    });


    var $dosyalar = $('#txtDosyalardanDosyaOdev').selectize({

        valueField: 'DosyaID',
        labelField: 'DosyaAdi',
        searchField: 'DosyaAdi',
        options: [],
        create: false,
        render: {
            option: function (item, escape) {

                return '<div class="media">' +
                            '<a class="pull-left" href="#">' +

                            '</a>' +

                            '<div class="media-body">' +
                                '<h5 class="media-heading"><strong>' + escape(item.Aciklama) + '</strong></h5>' +
                                '<small>' + escape(item.DosyaAdi) + '</small>' +

                            '</div>' +
                            '</div>';

            }
        },

        load: function (query, callback) {
            if (!query.length) return callback();

            $.ajax({
                url: '/Ajax/Dosya/JsonDosyaListesi.cshtml',
                data: {
                    sorgu: query
                },
                dataType: 'json',
                type: 'GET',
                error: function () {

                    HataMesaji(mesajlar.islemsirasindahata);
                    callback();
                },
                success: function (res) {

                    callback(res);
                }
            });

        },

        onItemAdd:
            function (data, $item) {

            }

    });

    $('.checkBoxOdevGonderimiAcKapa').click(function () {

        var dugme = $(this);
        var OdevID = $(this).attr('data-OdevID');
        var alan = 'OdevGonderimi';
        var gonderimAcikKapali = 0;

        if ($(this).prop("checked") == true) {
            gonderimAcikKapali = 1;
        }
        else if ($(this).prop("checked") == false) {
            gonderimAcikKapali = 2;
        }



        $.ajax({
            type: 'POST',
            url: '/Ajax/Odev/OdevAyarKaydet',
            data: "pk=" + OdevID + "&name=" + alan + "&value=" + gonderimAcikKapali,
            success: function (msg) {


            },
            error: function (msg) {

                HataMesaji(mesajlar.islemsirasindahata);
            }
        });


    });


