$('body').on('click', '.btnDersiTakipEt', function () {

    var DersID = $(this).attr('data-DersID');

    var dugme = $(this);

    $.ajax({
        type: 'POST',
        url: '/Ajax/DersTakip/DersiTakipEt',
        data: "DersID=" + DersID,
        success: function (msg) {
            if (msg == 'derstakipediliyor') {
                location.href = "/Ders/?DersID=" + DersID;
            }
            else if (msg == 'takipistegigonderildi') {
                
                MesajKutusu(mesajlar.islemtamam, mesajlar.takipistegigonderildi);
            }
        },
        error: function (msg) {
            if (msg.status == 501) {
                console.log(msg.status);
                HataMesaji(mesajlar.derstakipediliyorveyaistekgonderilmis);
            }
            else {
                HataMesaji(mesajlar.islemsirasindahata);
            }
        }
    });


});

$('body').on('click', '.btnDersTakipOnayVer', function () {

    var DersID = $(this).attr('data-DersID');
    var UserID = $(this).attr('data-UserID');
    var satir = $(this).closest('tr');
    
    $.ajax({
        type: 'POST',
        url: '/Ajax/DersTakip/Onayla',
        data: "DersID=" + DersID + "&UserID=" + UserID,
        success: function (msg) {
            $(satir).animate({ backgroundColor: 'gray' }, 150).fadeOut(150, function () {
                $(satir).remove();                
            });
            
            MesajKutusu(mesajlar.islemtamam,mesajlar.ogrencibasariylaonaylandi);
        },
        error: function (msg) {
             
            HataMesaji(mesajlar.islemsirasindahata);
        }
    });
   

});

$('body').on('click', '.btnDersTakipEngelle', function () {

    var DersID = $(this).attr('data-DersID');
    var UserID = $(this).attr('data-UserID');
    var satir = $(this).closest('tr');
    
    if (confirm(mesajlar.ogrencierisimdurdurulacak)) {

        $.ajax({
            type: 'POST',
            url: '/Ajax/DersTakip/Engelle',
            data: "DersID=" + DersID + "&UserID=" + UserID,
            success: function (msg) {
                satir.remove();

                MesajKutusu(mesajlar.islemtamam, mesajlar.ogrenciderseerisimdurduruldu);
            },
            error: function (msg) {

                HataMesaji(mesajlar.islemsirasindahata);
            }
        });

    }


});

$('body').on('click', '.btnDersTakibiBirak', function () {

    var DersID = $(this).attr('data-DersID');
    if (confirm('Emin misiniz ?')) {
        
        $.ajax({
            type: 'POST',
            url: '/Ajax/DersTakip/TakibiBirak',
            data: "DersID=" + DersID,
            success: function (msg) {
                location.href = "/Panel";
            },
            error: function (msg) {
                
               HataMesaji(mesajlar.islemsirasindahata);
            }
        });
        
    }

});

$('body').on('click', '.btnDersTakipReddet', function () {

    var DersID = $(this).attr('data-DersID');
    var UserID = $(this).attr('data-UserID');
    var satir = $(this).closest('tr');
    
    $.ajax({
        type: 'POST',
        url: '/Ajax/DersTakip/Reddet',
        data: "DersID=" + DersID + "&UserID=" + UserID,
        success: function (msg) {
            $(satir).animate({ backgroundColor: 'gray' }, 150).fadeOut(150, function () {
                $(satir).remove();
                 
            });

        },
        error: function (msg) {
             
            HataMesaji(mesajlar.islemsirasindahata);
        }
    });
   

});

var $ogrenciler = $('#txtOgrenciler').selectize({

    valueField: 'userID',
    labelField: 'adsoyad',
    searchField: 'adsoyad',
    options: [],
    create: false,
    render: {
        option: function (item, escape) {

            return '<div class="media">' +
                            '<a class="pull-left" href="#">' +
                            '<img class="media-object img-circle" src="http://bulutders.blob.core.windows.net/profilresimleri/' + escape(item.Avatar) + '" width="48" height="48">' +
                            '</a>' +

                            '<div class="media-body">' +
                                '<h5 class="media-heading">' + escape(item.adsoyad) + '</h5>' +

                            '</div>' +
                            '</div>';

        }
    },

    load: function (query, callback) {
        if (!query.length) return callback();
        
        $.ajax({
            url: '/Ajax/JsonOgrenciListesi.cshtml',
            data: {
                sorgu: query
            },
            dataType: 'json',
            type: 'GET',
            error: function () {
                
                alert('hata');
                callback();
            },
            success: function (res) {
                
                callback(res);
            }
        });
        
    },

    onItemAdd:
            function (data, $item) {

                var DersID = $("#divDersRow").attr("data-DersID");
                var control = $ogrenciler[0].selectize;
                var UserID = control.getValue();
                var ogrenciAdiSoyadi = control.getItem(control.getValue()).text();
                
                $.ajax({
                    type: 'POST',
                    dataType: "json",
                    url: '/Ajax/DersTakip/ErisimIzniVer',
                    data: "DersID=" + DersID + "&UserID=" + UserID,
                    success: function (msg) {
                        /*
                         tabloDersTakip.row.add([
                             '<span><img src="http://bulutders.blob.core.windows.net/profilresimleri/' + msg.Avatar +'" class="img-circle" style="width:48px;height: 48px"> <a href="#"> ' + msg.Ad + ' ' + msg.Soyad + '</a></span>',
                            'Az Önce',
                            '<button class="btn btn-danger btnDersTakipEngelle btn-sm" data-DersID="'+ DersID +'" data-UserID="' + UserID +'"><i class="fa fa-remove"></i></button>'
                        ]).draw();*/
                        control.clear();
                         
                    },
                    error: function (msg) {
                         
                        HataMesaji(mesajlar.islemsirasindahata);
                    }
                });
               


            }

});

$('#btnPanoMesajiGonder').click(function () {
        var DersID = $("#divDersRow").attr("data-DersID");
        var mesajMetni = $("#txtPanoMesaji").val();
        if (mesajMetni == '') {
            $("#txtPanoMesaji").focus();
            return false;
        }
       
        $.ajax({
            type: 'POST',
            url: '/Ajax/Ders/PanoyaMesajEkle',
            data: "DersID=" + DersID + "&MesajMetni=" + encodeURIComponent(mesajMetni),
            success: function (msg) {
                var eklenecekHtml = '<tr>' +
                '<td>' + $("#divAktifKullaniciKucukKunye").html() + '</td>' +
                '<td>' + mesajMetni + '</td>' +
                '<td class="text-right"> ' + mesajlar.azonce + ' </td>' +
                '<td class="text-right">' + '<button class="btn btn-danger btn-xs panoOgesiSil" data-PanoOgeID="' + msg + '"><i class="fa fa-remove"></i></button>' + '</td>'

                + '</tr>';
                $('#tableDersPanosu').prepend(eklenecekHtml);
                $("#txtPanoMesaji").val('');
                 
            },
            error: function (msg) {
                 
                HataMesaji(mesajlar.mesajpaylasilirkenhata);
            }
        });
       
    });

$('body').on('click', '.chkBoxOge', function () {
           var satir = $(this).closest("tr");

           if (this.checked) {

               $(satir).addClass("warning");
               $('#btnCokluSil').prop('disabled', false);

           }
           else {
               $(satir).removeClass("warning");
           }

           var seciliOgeSayisi = 0;


           $('.chkBoxOge').each(function (id, jd) {

               if (this.checked) {

                   seciliOgeSayisi++;

               }

           });

           if (seciliOgeSayisi == 0) {
               $('#btnCokluSil').prop('disabled', true);
               $('#btnDerstePaylas').prop('disabled', true);
           }
           else {
               $('#btnCokluSil').prop('disabled', false);
               $('#btnDerstePaylas').prop('disabled', false);
           }




       });

$('body').on('click', '.btnOgeSil', function () {
        var satir = $(this).closest("tr");
        var ogeID = $(this).attr('data-OgeID');
        if (confirm('Seçili öğe kalıcı olarak silinecek emin misiniz ?')) {
            $.ajax({
                type: 'POST',
                url: '/Ajax/Dosya/OgeSil',
                data: 'OgeID=' + ogeID,
                success: function (res) {
                    $(satir).animate({ backgroundColor: 'gray' }, 150).fadeOut(150, function () {
                        $(satir).remove()
                    });

                },
                error: function (res) {
                    HataMesaji('Öğe silinirken bir hata meydana geldi');
                    return false;
                }
            });
        }
    });

$('body').on('click', '#btnCokluSil', function () {
        var silecekOgeler = '';
        $('.chkBoxOge').each(function () {
            if (this.checked) {
                silecekOgeler = silecekOgeler + $(this).attr("data-OgeID") + ",";
            }

        });
        silecekOgeler = silecekOgeler.substring(0, silecekOgeler.length - 1)
        if (silecekOgeler != "") {
            if (confirm('Seçili öğeler kalıcı olarak silinecek. Emin misiniz ?')) {
                $.ajax({
                    type: 'POST',
                    url: '/Ajax/Dosya/OgeSil',
                    data: {
                        OgeID: silecekOgeler
                    },
                    success: function (res) {
                        $('.chkBoxOge').each(function () {
                            if (this.checked) {
                                var satir = $(this).closest('tr');

                                $(satir).remove()

                            }
                        });



                    },
                    error: function (res) {
                        HataMesaji('Öğe silinirken bir hata meydana geldi');
                        return false;
                    }
                });
            }

        }

    });

$('body').on('change', '.chkBoxDersSecOge', function () {
        var secili = this.checked;
      
        var satir = $(this).closest("tr");
        if (secili) {
            $(satir).addClass("warning");
        }
        else {
            $(satir).removeClass("warning");
        }
    });


$('#modalDersSec').on('shown.bs.modal', function (e) {
        VerilenDersleriGoster();
    });

    
function VerilenDersleriGoster()
    {
              $('#spinnerIconDers').removeClass('hide');
              $('#tableVerilenDerslerListesi').addClass('hide');
              $.ajax({
                  url: '/Ajax/Ders/JsonVerilenDersler.cshtml',

                  dataType: 'json',
                  type: 'GET',
                  error: function (hata) {

                      return false;

                  },
                  success: function (res) {
                      
                      $('#tableVerilenDerslerListesi').empty();


                      for (var i = 0; i < res.length; i++) {

                          var eklenecekHtml = '';
                          eklenecekHtml = '<tr>' +
                '<td class="col-md-1 text-center">' +
                '<label>' +
                '<input type="checkbox" data-DersID="' + res[i].DersID + '" class="colored-primary chkBoxDersSecOge">' +
                '<span class="text"></span>' +
                '</label>' +
                '</td>' +
                '<td>' +
                '<button class="btn btn-link"><i class="fa fa-book fa-2x"></i>' + res[i].DersAdi + '</button>' +
                '</td>' +

                '</tr>';
                          $('#tableVerilenDerslerListesi').append(eklenecekHtml);

                      }
                      $('#spinnerIconDers').addClass('hide');
                      $('#tableVerilenDerslerListesi').removeClass('hide');
                  }
              });  
    }

    
$('#btnDerstePaylasTamam').click(function () {

        var paylasilacakDersler = '';
        var paylasilacakDosyalar = '';

        $('.chkBoxOge').each(function () {
            if (this.checked) {
                paylasilacakDosyalar = paylasilacakDosyalar + $(this).attr("data-OgeID") + ",";
            }

        });
        paylasilacakDosyalar = paylasilacakDosyalar.substring(0, paylasilacakDosyalar.length - 1)

        if (paylasilacakDosyalar == "") {
            HataMesaji('Lütfen paylaşılmasını istediğiniz dosyaları seçin');
            return false;
        }


        $('.chkBoxDersSecOge').each(function () {
            if (this.checked) {
                paylasilacakDersler = paylasilacakDersler + $(this).attr("data-DersID") + ",";
            }

        });
        paylasilacakDersler = paylasilacakDersler.substring(0, paylasilacakDersler.length - 1)

        if (paylasilacakDersler == '') {
            HataMesaji('Lütfen paylaşılmasını istediğiniz dersleri seçin');
            return false;
        }

        $('#spinnerIconDers').removeClass('hide');
        $('#tableVerilenDerslerListesi').addClass('hide');

        $.ajax({
            type: 'POST',
            url: '/Ajax/Dosya/ErisimIzniVerDers',
            data: {
                DersID: paylasilacakDersler,
                DosyaID: paylasilacakDosyalar
            },
            success: function (res) {
                $('#spinnerIconDers').addClass('hide');
                $('#tableVerilenDerslerListesi').removeClass('hide');
                $('#modalDersSec').modal('hide');
                MesajKutusu(mesajlar.islemtamam, 'Dosyalar derse başarıyla paylaşıldı');

            },
            error: function (res) {
                HataMesaji('Dosyalar derste paylaşılırken bir hata meydana geldi');
                return false;
            }
        });




    });



    $('body').on('click', '.panoOgesiSil', function () {

        var ID = $(this).attr('data-PanoOgeID');
        var satir = $(this).closest('tr');
        if (confirm(mesajlar.mesajsilinecek)) {
            $.ajax({
                type: 'POST',
                url: '/Ajax/Ders/PanodanMesajSil',
                data: "ID=" + ID,
                success: function (msg) {
                    $(satir).animate({ backgroundColor: 'gray' }, 150).fadeOut(150, function () {
                        $(satir).remove();
                    });

                },
                error: function (msg) {
                    HataMesaji(mesajlar.islemsirasindahata);
                }
            });
        }

    });


    $('body').on('click', '.btnOdevSil', function () {
        var OdevID = $(this).attr('data-OdevID');
        var satir = $(this).closest('tr');
        if (confirm(mesajlar.odevsilinecek)) {

            $.ajax({
                type: 'POST',
                url: '/Ajax/Odev/OdevSil',
                data: "OdevID=" + OdevID,
                success: function (msg) {
                    satir.remove();
                },
                error: function (msg) {
                    HataMesaji(mesajlar.islemsirasindahata);
                }
            });
        }
    });


    $('.checkBoxOdevGonderimiAcKapa').click(function () {

        var dugme = $(this);
        var OdevID = $(this).attr('data-OdevID');
        var alan = 'OdevGonderimi';
        var gonderimAcikKapali = 0;

        if ($(this).prop("checked") == true) {
            gonderimAcikKapali = 1;
        }
        else if ($(this).prop("checked") == false) {
            gonderimAcikKapali = 2;
        }



        $.ajax({
            type: 'POST',
            url: '/Ajax/Odev/OdevAyarKaydet',
            data: "pk=" + OdevID + "&name=" + alan + "&value=" + gonderimAcikKapali,
            success: function (msg) {


            },
            error: function (msg) {

                HataMesaji(mesajlar.islemsirasindahata);
            }
        });


    });


$('body').on('click', '.btnDosyayiCikar', function () {

    var DosyaID = $(this).attr('data-DosyaID');
    var DersID = $("#divDersRow").attr("data-DersID");
    var row = tabloDersDosyalari.row($(this).parents('tr'));
    if (confirm(mesajlar.erisimiznikaldirilacak)) {
       
        $.ajax({
            type: 'POST',
            url: '/Ajax/Dosya/ErisimIzniniKaldirDers',
            data: "DersID=" + DersID + "&DosyaID=" + DosyaID,
            success: function (msg) {
                 row.remove().draw();
                  
            },
            error: function (msg) {
                 
                HataMesaji(mesajlar.islemsirasindahata);
            }
        });
       
    }

});


