$(function () {


    $('#cmbDersID').selectize();


    $('input[name="SonTeslimTarihi"]').daterangepicker({
        singleDatePicker: true,
        showDropdowns: true,
        format: ayarlar.dtformat,
        drops: 'down',
        buttonClasses: ['btn', 'btn-sm'],
        applyClass: 'btn-primary',
        cancelClass: 'btn-default',
        locale: ayarlar.dtpickerlocale
    },
    function (start, end, label) {

    });


    $("#txtBilgisayardanDosya").change(function () {

        var file = this.files[0];
        name = file.name;
        size = file.size;
        type = file.type;

        if (size > 1000000) {
            $("#txtBilgisayardanDosya").val('');
            HataMesaji(mesajlar.dosyaboyutubuyuk);
        }
        else {
            $.ajax({
                type: 'POST',
                url: '/Ajax/Dosya/Yervarmi',
                data: "DosyaBoyut=" + size,

                error: function (msg) {
                    if (msg.status == 502) {
                        $("#txtBilgisayardanDosya").val('');
                        HataMesaji(mesajlar.yetersizdepolamaalani);
                    }
                }
            });
        }

    });

    $('#btnOdevVer').click(function () {

        var dosyadanTabSecili = $('#tabDosyalar').hasClass('active');

        if (dosyadanTabSecili) {
            $('#txtBilgisayardanDosya').val('');

        }
        else {
            $('#cmbDosyalardanDosya').val('');
        }

        var odevBaslik = $('#txtOdevBaslik').val();
        var DersID = $('#cmbDersID').val();

        if (DersID == '') {
            $('#cmbDersID').focus();
            HataMesaji(mesajlar.derssecilmedi);
            return false;
        }

        if (odevBaslik == '') {
            $('#txtOdevBaslik').focus();
            HataMesaji(mesajlar.basliksecilmedi);
            return false;
        }


        $("#frmOdevEkle").ajaxSubmit({
            url: '/Ajax/Odev/OdevVer',
            dataType: "json",
            type: 'post',
            success: function (msg) {
                var eklenecekHtml = '';
                eklenecekHtml = '<tr>';
                eklenecekHtml += '<td><a href="/Odev/Goster?OdevID=' + msg.OdevID + '"><i class="fa fa-clock-o fa-2x text-success"></i> ' + msg.Baslik + ' </a></td>';
                eklenecekHtml += '<td><div class="dropdown"><button id="dLabel" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="btn btn-primary btn-xs"><i class="fa fa-cog"></i><span class="caret"></span></button>';
                eklenecekHtml += '<ul class="dropdown-menu" aria-labelledby="dLabel">';
                eklenecekHtml += '<li><a href="/Odev/Goster?OdevID=' + msg.OdevID + '"><i class="fa fa-search-plus"></i> ' + mesajlar.gozat + '</a></li>';
                eklenecekHtml += '<li><a href="/Odev/Ayarlar?OdevID=' + msg.OdevID + '"><i class="fa fa-cog"></i> ' + mesajlar.odevayarlari + '</a></li>';
                eklenecekHtml += '<li><a href="/Odev/OdevGonderileri?OdevID=' + msg.OdevID + '"><i class="fa fa-user"></i> ' + mesajlar.odevinigonderenler + '</a></li>';
                eklenecekHtml += '<li><a href="#" class="btnOdevSil" data-OdevID="' + msg.OdevID + '"><i class="fa fa-remove"></i> Ã–devi Sil</a></li></ul></div></td>';
                eklenecekHtml += '<td><a href="/Ders?DersID=' + msg.DersID + '"> ' + msg.DersAdi + ' </a> </td>';

                $('#lstOdevler tbody').prepend(eklenecekHtml);

                $('#modalYeniOdevVer').modal('hide');
                MesajKutusu(mesajlar.islemtamam, mesajlar.odevbasariylaeklendi);
            },

            error: function (msg) {

                if (msg.status == 502) {
                    HataMesaji(mesajlar.yetersizdepolamaalani);
                }
                else {
                    HataMesaji(mesajlar.verilmesirasindabirhataolustu);
                }
            }

        });



    });

    $('#modalYeniOdevVer').on('hidden.bs.modal', function (e) {
        FormuTemizle();
    })

    function FormuTemizle() {
        $('#cmbDersID').val('');
        $('#txtOdevBaslik').val('');
        $("#txtBilgisayardanDosya").val('');
        $("#txtAciklama").val('');
        $("#cmbDersID").val('0');
        $("#txtSonTeslimTarihi").val('');
    }

    $('body').on('click', '.btnOdevSil', function () {
        var OdevID = $(this).attr('data-OdevID');

        var satir = $(this).closest('tr');
        if (confirm(mesajlar.odevsilinecek)) {

            $.ajax({
                type: 'POST',
                url: '/Ajax/Odev/OdevSil',
                data: "OdevID=" + OdevID,
                success: function (msg) {

                    satir.remove();
                },
                error: function (msg) {
                    HataMesaji(mesajlar.islemsirasindabirhataolustu);
                }
            });
        }
    });

    var $dosyalar = $('#cmbDosyalardanDosya').selectize({

        valueField: 'DosyaID',
        labelField: 'DosyaAdi',
        searchField: 'DosyaAdi',
        options: [],
        create: false,
        render: {
            option: function (item, escape) {

                return '<div class="media">' +
                            '<a class="pull-left" href="#">' +

                            '</a>' +

                            '<div class="media-body">' +
                                '<h5 class="media-heading"><strong>' + escape(item.Aciklama) + '</strong></h5>' +
                                '<small>' + escape(item.DosyaAdi) + '</small>' +

                            '</div>' +
                            '</div>';

            }
        },

        load: function (query, callback) {
            if (!query.length) return callback();

            $.ajax({
                url: '/Ajax/Dosya/JsonDosyaListesi.cshtml',
                data: {
                    sorgu: query
                },
                dataType: 'json',
                type: 'GET',
                error: function () {

                    alert(mesajlar.islemsirasindabirhataolustu);
                    callback();
                },
                success: function (res) {

                    callback(res);
                }
            });

        },

        onItemAdd:
            function (data, $item) {


            }

    });

});