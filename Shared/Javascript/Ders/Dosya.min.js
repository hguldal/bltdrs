var tabloDersDosyalari = $('#lstDersDosyalari').DataTable({
    "pagingType": "simple",
    "language": {
        "url": ayarlar.datatablelangurl
    },
    "bPaginate": true,
    "bLengthChange": false,
    "bFilter": false,
    "bInfo": false,
    "bSort": false
});

$('body').on('click', '.btnDosyayiCikar', function () {

    var DosyaID = $(this).attr('data-DosyaID');
    var DersID = $("#divDersRow").attr("data-DersID");
    var row = tabloDersDosyalari.row($(this).parents('tr'));
    if (confirm(mesajlar.erisimiznikaldirilacak)) {
       
        $.ajax({
            type: 'POST',
            url: '/Ajax/Dosya/ErisimIzniniKaldirDers',
            data: "DersID=" + DersID + "&DosyaID=" + DosyaID,
            success: function (msg) {
                 row.remove().draw();
                  
            },
            error: function (msg) {
                 
                HataMesaji(mesajlar.islemsirasindahata);
            }
        });
       
    }

});




var $dosyalar = $('#txtDosyalarimdanBul').selectize({

        valueField: 'DosyaID',
        labelField: 'DosyaAdi',
        searchField: 'DosyaAdi',
        options: [],
        create: false,
        render: {
            option: function (item, escape) {

                return '<div class="media">' +
                            '<a class="pull-left" href="#">' +

                            '</a>' +

                            '<div class="media-body">' +
                                '<h5 class="media-heading">' + escape(item.Aciklama) + '</h5>' +
                                '<small>' + escape(item.DosyaAdi) + '</small>' +

                            '</div>' +
                            '</div>';

            }
        },

        load: function (query, callback) {
            if (!query.length) return callback();
            $.ajax({
                url: '/Ajax/Dosya/JsonDosyaListesi.cshtml',
                data: {
                    sorgu: query
                },
                dataType: 'json',
                type: 'GET',
                error: function () {
                    alert('hata');
                    callback();
                },
                success: function (res) {
                    callback(res);
                }
            });
        },

        onItemAdd:
            function (data, $item) {

                var DersID = $("#divDersRow").attr("data-DersID");
                var control = $dosyalar[0].selectize;

                var DosyaID = control.getValue();
                $('#modalDerseDosyaEkle').modal('hide');
                
                $.ajax({
                    type: 'POST',
                    url: '/Ajax/Ders/DosyaEkle',
                    dataType: "json",
                    data: "DosyaID=" + DosyaID + "&DersID=" + DersID,
                    success: function (msg) {
                        
                            var boyut = "";
                            if (msg.Boyut < 1048576) {
                                boyut = Math.round(msg.Boyut / 1024) + ' KB';
                            }
                            else {
                                boyut = Math.round(msg.Boyut / 1048576) + ' MB';
                            }
                            tabloDersDosyalari.row.add([
                            '<i class="fa fa-file-text-o fa-2x text-success"></i> ' + '<a href="/Dosya/Indir?DosyaID=' + msg.DosyaID + '">' + msg.Aciklama + '</a> ',
                            '<a href="/Dosya/Indir?DosyaID=' + msg.DosyaID + '" >' + msg.DosyaAdi + '</a>',
                            boyut,
                            '<a href="/Dosya/Indir?DosyaID=' + msg.DosyaID + '" class="btn btn-info"><i class="fa fa-cloud-download"></i></a> ' +
                            '<a href="/Dosya/Ayarlar?DosyaID=' + msg.DosyaID + '" class="btn btn-warning"><i class="fa fa-cog"></i></a> ' +
                            '<button class="btn btn-danger btnDosyayiCikar" data-DosyaID="' + msg.DosyaID + '"><i class="fa fa-remove"></i></button> '

                        ]).draw();
                            
                            MesajKutusu(mesajlar.islemtamam, mesajlar.dosyabasariylaeklendi);
                            control.clear();
                        
                    },
                    error: function (msg) {
                         control.clear(); 
                         
                        if (msg.status == 501) {
                            

                            HataMesaji(mesajlar.dosyazatenekli);
                        }
                        else {
                            
                            HataMesaji(mesajlar.islemsirasindahata);
                        }

                    }
                });
               

            }

    });


var maxBlockSize = 1 * 1024 * 1024;
var numberOfBlocks = 1;
var selectedFile = null;
var currentFilePointer = 0;
var totalBytesRemaining = 0;
var blockIds = new Array();
var blockIdPrefix = "block-";
var submitUri = null;
var bytesUploaded = 0;
var yVarmi = true;
var azureDosyaAdi = '';

$("#txtDosya").change(function () {
           var file = this.files[0];
           name = file.name;
           size = file.size;
           type = file.type;

           if (size > 200000000) {
               $("#txtDosya").val('');
               HataMesaji(mesajlar.dosyaboyutubuyuk);
           }
           else {
              
               $.ajax({
                   type: 'POST',
                   url: '/Ajax/Dosya/Yervarmi',
                   data: "DosyaBoyut=" + size,
                   success: function (msg) {
                       yVarmi = true;
                   },
                   error: function (msg) {
                       if (msg.status == 502) {
                           $("#txtDosya").val('');
                           yVarmi = false;
                            
                           HataMesaji(mesajlar.dosyaicinyetersizalan);
                       }
                       else {
                            
                           HataMesaji(mesajlar.dosyaeklenirkenhata);
                       }
                   }
               });
              
           }

       });

$('#btnDosyaEkle').click(function () {

           var file = $('#txtDosya')[0].files[0];

           if (file == null) {
               $('#txtDosya').focus();
               HataMesaji(mesajlar.dosyasecilmedi);
               return false;
           }
           $('#modalDerseDosyaEkle').modal('hide');
           handleFileSelect();
           UIBlockProgress();

           $.ajax({
               type: 'GET',
               url: '/Ajax/Dosya/YeniGuid',
               success: function (res) {

                   azureDosyaAdi = res + '.' + selectedFile.name.substr(selectedFile.name.lastIndexOf('.') + 1);


                   $.ajax({
                       type: 'GET',
                       url: '/Ajax/Dosya/AzureSaSOlustur?AzureDosyaAdi=' + azureDosyaAdi,

                       success: function (res) {
                           submitUri = res;
                           uploadFileInBlocks();

                       },
                       error: function (res, status, xhr) {
                           HataMesaji("Microsoft Azure: Can't get the Shared Access Signature");
                       }
                   });

               },
               error: function (res) {
                   HataMesaji(mesajlar.dosyaeklenirkenhata);
                   return false;
               }
           });

       });


function handleFileSelect() {
           maxBlockSize = 1 * 1024 * 1024;
           currentFilePointer = 0;
           totalBytesRemaining = 0;

           selectedFile = $('#txtDosya')[0].files[0];

           var fileSize = selectedFile.size;
           if (fileSize < maxBlockSize) {
               maxBlockSize = fileSize;

           }
           totalBytesRemaining = fileSize;
           if (fileSize % maxBlockSize == 0) {
               numberOfBlocks = fileSize / maxBlockSize;
           } else {
               numberOfBlocks = parseInt(fileSize / maxBlockSize, 10) + 1;
           }

       }

var reader = new FileReader();

reader.onloadend = function (evt) {
    if (evt.target.readyState == FileReader.DONE) {
        var uri = submitUri + '&comp=block&blockid=' + blockIds[blockIds.length - 1];
        var requestData = new Uint8Array(evt.target.result);
        $.ajax({
            url: uri,
            type: "PUT",
            data: requestData,
            processData: false,
            beforeSend: function (xhr) {
                xhr.setRequestHeader('x-ms-blob-type', 'BlockBlob');

            },
            success: function (data, status) {
                bytesUploaded += requestData.length;
                var percentComplete = ((parseFloat(bytesUploaded) / parseFloat(selectedFile.size)) * 100).toFixed(1);
                $('#uploadProgress').attr('value', percentComplete);

                uploadFileInBlocks();
            },
            error: function (xhr, desc, err) {
                HataMesaji(desc);
            }
        });
    }
};

function uploadFileInBlocks() {
           if (totalBytesRemaining > 0) {

               var fileContent = selectedFile.slice(currentFilePointer, currentFilePointer + maxBlockSize);
               var blockId = blockIdPrefix + pad(blockIds.length, 6);

               blockIds.push(btoa(blockId));
               reader.readAsArrayBuffer(fileContent);
               currentFilePointer += maxBlockSize;
               totalBytesRemaining -= maxBlockSize;
               if (totalBytesRemaining < maxBlockSize) {
                   maxBlockSize = totalBytesRemaining;
               }
           } else {
               commitBlockList();
           }
       }

function commitBlockList() {
           var uri = submitUri + '&comp=blocklist';

           var requestBody = '<?xml version="1.0" encoding="utf-8"?><BlockList>';
           for (var i = 0; i < blockIds.length; i++) {
               requestBody += '<Latest>' + blockIds[i] + '</Latest>';
           }
           requestBody += '</BlockList>';

           $.ajax({
               url: uri,
               type: "PUT",
               data: requestBody,
               beforeSend: function (xhr) {
                   xhr.setRequestHeader('x-ms-blob-content-type', selectedFile.type);

               },
               success: function (data, status) {
                   console.log(data);
                   console.log(status);
                   var aciklama = $('#txtAciklama').val();
                   var dersID = $('#txtDersID').val();
                   DosyayiYukleDerseKaydet(dersID, selectedFile.name, selectedFile.size, selectedFile.type, azureDosyaAdi, aciklama);
                   
               },
               error: function (xhr, desc, err) {
                   console.log(desc);
                   console.log(err);
                   HataMesaji(mesajlar.dosyaeklenirkenhata + ' ' + desc);
               }
           });

       }
function pad(number, length) {
           var str = '' + number;
           while (str.length < length) {
               str = '0' + str;
           }
           return str;
       }
function DosyayiYukleDerseKaydet(DersID,dosyaAdi, dosyaBoyut, dosyaTuru, azureDosyaAdi, aciklama) {

    $.ajax({
        type: 'POST',
        dataType: 'json',
        url: '/Ajax/Ders/DosyaYukleEkle?DersID=' + DersID + '&AzureDosyaAdi=' + azureDosyaAdi + '&Aciklama=' + aciklama + '&DosyaBoyut=' + dosyaBoyut + '&DosyaAdi=' + dosyaAdi + '&DosyaTuru=' + dosyaTuru,
        success: function (msg) {
            
            tabloDersDosyalari.row.add([
                            '<i class="fa fa-file-text-o fa-2x text-success"></i> ' + '<a href="/Dosya/Indir?DosyaID=' + msg.DosyaID + '">' + msg.Aciklama + '</a> ',
                            '<a href="/Dosya/Indir?DosyaID=' + msg.DosyaID + '" >' + msg.DosyaAdi + '</a>',
                            dosyaBoyut,
                            '<a href="/Dosya/Indir?DosyaID=' + msg.DosyaID + '" class="btn btn-info btn-sm"><i class="fa fa-cloud-download"></i></a> ' +
                            '<a href="/Dosya/Ayarlar?DosyaID=' + msg.DosyaID + '" class="btn btn-warning btn-sm"><i class="fa fa-cog"></i></a> ' +
                            '<button class="btn btn-danger btnDosyayiCikar btn-sm" data-DosyaID="' + msg.DosyaID + '"><i class="fa fa-remove"></i></button> '

                        ]).draw();
            UIUnBlock();
            MesajKutusu(mesajlar.islemtamam, mesajlar.dosyabasariylaeklendi);
            $('#txtDosya').val('');

        },
        error: function (msg) {
             
            if (msg.status == 502) {
                HataMesaji(mesajlar.dosyaicinyetersizalan);
            }
            else {
                HataMesaji(mesajlar.dosyaeklenirkenhata);
            }

        }
    });

    }


