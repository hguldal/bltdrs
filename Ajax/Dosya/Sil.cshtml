@using Microsoft.WindowsAzure.Storage;
@using Microsoft.WindowsAzure.Storage.Auth;
@using Microsoft.WindowsAzure.Storage.Blob;
@{
    if (!WebSecurity.IsAuthenticated)
     {
        
        Response.StatusCode=401;
        Response.End(); 
     }

     var DosyaID=Request["DosyaID"];

     if (string.IsNullOrEmpty(DosyaID))
     {
         Response.StatusCode=500;
         Response.End();
     }
    var db=Database.Open("fb1ae");
    var queryDosya=db.QuerySingle("SELECT * FROM Dosya WHERE DosyaID=@0 AND UserID=@1 AND Silindi=0",DosyaID,WebSecurity.CurrentUserId);
   
    if (queryDosya==null)
      {
        db.Close();
        Response.StatusCode=500;
        Response.End();  
      }

      db.Execute("DELETE FROM DosyaIzinKisi WHERE DosyaID=@0",DosyaID);
      db.Execute("DELETE FROM DosyaIzinDers WHERE DosyaID=@0",DosyaID);
      db.Execute("DELETE FROM DersDosyalari WHERE DosyaID=@0",DosyaID);
      db.Execute("UPDATE OdevGonderisi SET DosyaID=-1 WHERE DosyaID=@0",DosyaID);
      db.Execute("UPDATE Odev SET DosyaID=-1 WHERE DosyaID=@0",DosyaID);
      db.Execute("UPDATE Dosya SET Silindi=1 WHERE DosyaID=@0",DosyaID);

      
      var azureStorageHesapAdi=System.Configuration.ConfigurationManager.AppSettings["AzureStorageHesapAdi"];	
      var azureStorageHesapAnahtari=System.Configuration.ConfigurationManager.AppSettings["AzureStorageHesapAnahtari"];
  
      var connString=string.Format("DefaultEndpointsProtocol=http;AccountName={0};AccountKey={1};",azureStorageHesapAdi,azureStorageHesapAnahtari);
      CloudStorageAccount storageHesap = CloudStorageAccount.Parse(connString);		
      var blobIstemci = storageHesap.CreateCloudBlobClient();
      var container = blobIstemci.GetContainerReference("dosyalar");
      CloudBlockBlob blockBlob = container.GetBlockBlobReference(queryDosya.KayitAdi);
      blockBlob.Delete();
      
      Response.Write("OK");
      Response.End();

}
