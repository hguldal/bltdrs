$(document).ready(function () {

    $('#cmbErisim').val($('#cmbErisim').attr('data-ilkdeger'));

    $('#lnkDosyaAdi').editable(
    {
        pk: function () {
            return $("#spnDosyaID").attr("data-DosyaID")
        },

        name: 'DosyaAdi',

        url: '/Ajax/Dosya/AyarKaydet',

        display: function (value) {
            $(this).text(value + '');
        },

        success: function (msg) {

            MesajKutusu(mesajlar.islemtamam, mesajlar.dosyaayarlaribasariylakaydedildi);

        }
    });


    $('#lnkDosyaAciklama').editable(
    {
        pk: function () {
            return $("#spnDosyaID").attr("data-DosyaID")
        },

        name: 'Aciklama',

        url: '/Ajax/Dosya/AyarKaydet',

        display: function (value) {
            $(this).text(value + '');
        },

        success: function (msg) {

             MesajKutusu(mesajlar.islemtamam, mesajlar.dosyaayarlaribasariylakaydedildi);

        }
    });


    $('#cmbErisim').selectize(
    {

        onItemAdd:
            function (data, $item) {
                var alan = 'Erisim';
                var DersID = $("#spnDosyaID").attr("data-DosyaID");
                var deger = data;
                
                $.ajax({
                    type: 'POST',
                    url: '/Ajax/Dosya/AyarKaydet',
                    data: "pk=" + DersID + "&name=" + alan + '&value=' + deger,
                    success: function (msg) {
                         
                         MesajKutusu(mesajlar.islemtamam, mesajlar.dosyaayarlaribasariylakaydedildi);
                    },
                    error: function (msg) {
                         
                        HataMesaji(mesajlar.dosyaayarlarikaydedilirkenhata);
                    }
                });
               
            }
    });



    var $kisiler = $('#txtIzinverilecekKisiler').selectize({

        valueField: 'userID',
        labelField: 'adsoyad',
        searchField: 'adsoyad',
        options: [],
        create: false,
        render: {
            option: function (item, escape) {

                return '<div class="media">' +
                            '<a class="pull-left" href="#">' +
                            '<img class="media-object img-circle" src="http://bulutders.blob.core.windows.net/profilresimleri/' + escape(item.Avatar) + '" width="48" height="48">' +
                            '</a>' +

                            '<div class="media-body">' +
                                '<h5 class="media-heading">' + escape(item.adsoyad) + '</h5>' +

                            '</div>' +
                            '</div>';

            }
        },

        load: function (query, callback) {
            if (!query.length) return callback();
           
            $.ajax({
                url: '/Ajax/JsonKisiListesi.cshtml',
                data: {
                    sorgu: query
                },
                dataType: 'json',
                type: 'GET',
                error: function () {
                     
                  
                    callback();
                },
                success: function (res) {
                     
                    callback(res);
                }
            });
           
        },

        onItemAdd:
            function (data, $item) {

                var DosyaID = $("#spnDosyaID").attr("data-DosyaID");
                var control = $kisiler[0].selectize;

                var UserID = control.getValue();
                var kisiAdiSoyadi = control.getItem(control.getValue()).text();
                
                $.ajax({
                    type: 'POST',
                    url: '/Ajax/Dosya/ErisimIzniVerKisi',
                    data: "DosyaID=" + DosyaID + "&UserID=" + UserID,
                    success: function (msg) {
                         
                        if (msg == 'OK') {
                            $('#cmbDosyaErisimIzinleri').prepend('<option value="' + UserID + '" selected >' + kisiAdiSoyadi + '</option>');
                            control.clear();
                        }
                        else if (msg == 'zatenvar') {
                            control.clear();
                            HataMesaji(mesajlar.kisiicinzatenerisimhakkivar);
                            return false;
                        }
                        else if (msg == 'sahip') {
                            control.clear();
                            HataMesaji(mesajlar.kisizatensahip);
                            return false;
                        }
                    },
                    error: function (msg) {
                         
                        HataMesaji(mesajlar.islemsirasindahata);
                    }
                });
               



            }

    });


    $('#btnDosyaErisimIzniKaldir').click(function () {
        var DosyaID = $("#spnDosyaID").attr("data-DosyaID");
        var UserID = $('#cmbDosyaErisimIzinleri').val();

        if (confirm(mesajlar.erisimdurdurulacak)) {
            
            $.ajax({
                type: 'POST',
                url: '/Ajax/Dosya/ErisimIzniniKaldirKisi',
                data: "DosyaID=" + DosyaID + "&UserID=" + UserID,
                success: function (msg) {
                     
                    $("#cmbDosyaErisimIzinleri option:selected").remove();
                    MesajKutusu(mesajlar.islemtamam, mesajlar.erisimdurduruldu);

                },
                error: function (msg) {
                     
                    HataMesaji(mesajlar.islemsirasindahata);
                }
            });
           
        }


    });

    var $dersler = $('#txtIzinverilecekDersler').selectize({

        valueField: 'DersID',
        labelField: 'DersAdi',
        searchField: 'DersAdi',
        options: [],
        create: false,
        render: {
            option: function (item, escape) {

                return '<div class="media">' +
                            '<a class="pull-left" href="#">' +
                            
                            '</a>' +

                            '<div class="media-body">' +
                                '<h5 class="media-heading">' + escape(item.DersAdi) + '</h5>' +
                                '<small>' + escape(item.Aciklama) +'</small>' +

                            '</div>' +
                            '</div>';

            }
        },

        load: function (query, callback) {
            if (!query.length) return callback();
            
            $.ajax({
                url: '/Ajax/Ders/JsonVerilenDersler.cshtml',
                data: {
                    sorgu: query
                },
                dataType: 'json',
                type: 'GET',
                error: function () {
                    
                    callback();
                },
                success: function (res) {
                     
                    callback(res);
                }
            });
          
        },

        onItemAdd:
            function (data, $item) {
               
                var DosyaID = $("#spnDosyaID").attr("data-DosyaID");
                var control = $dersler[0].selectize;

                var DersID = control.getValue();
                var DersAdi = control.getItem(control.getValue()).text();

                $.ajax({
                    type: 'POST',
                    url: '/Ajax/Dosya/ErisimIzniVerDers',
                    data: "DosyaID=" + DosyaID + "&DersID=" + DersID,
                    success: function (msg) {
                        if (msg == 'OK') {
                            $('#cmbDosyaErisimIzinleriDers').prepend('<option value="' + DersID + '" selected >' + DersAdi + '</option>');
                            control.clear();
                        }
                        else if (msg == 'zatenvar') {
                            control.clear();
                            HataMesaji(mesajlar.dersicinerisimhakkivar);
                            return false;
                        }
                        
                    },
                    error: function (msg) {
                        HataMesaji(mesajlar.islemsirasindahata);
                    }
                });

                

            }

    });


    $('#btnDosyaErisimIzniKaldirDers').click(function () {
        var DosyaID = $("#spnDosyaID").attr("data-DosyaID");
        var DersID = $('#cmbDosyaErisimIzinleriDers').val();

        if (confirm(mesajlar.dersicinerisimdurdurulacak)) {
            
            $.ajax({
                type: 'POST',
                url: '/Ajax/Dosya/ErisimIzniniKaldirDers',
                data: "DosyaID=" + DosyaID + "&DersID=" + DersID,
                success: function (msg) {
                    $("#cmbDosyaErisimIzinleriDers option:selected").remove();
                     
                    MesajKutusu(mesajlar.islemtamam, mesajlar.dersicinerisimdurduruldu);

                },
                error: function (msg) {
                     
                    HataMesaji(mesajlar.islemsirasindahata);
                }
            });
           
        }


    });
});